name: Unblock permission
on:
  push:
    branches:
      - evgeny-fix-srtools-permissions

jobs:
  unblock:
    name: Fix Docker-created file permissions
    runs-on: [self-hosted]
    timeout-minutes: 10

    steps:
      - name: Fix ownership with podman unshare
        run: |
          pwd
          
          if [ -d chains/orchestrator-relays/runtime/starlight/target/srtool ]; then
            ls -ln chains/orchestrator-relays/runtime/starlight
            docker run --rm -v ${PWD}:/build alpine \
              sh -c "rm -rf /build/chains/orchestrator-relays/runtime/starlight/target"
          else
            echo "starlight srtool dir not found, skipping chown"
          fi

          if [ -d chains/orchestrator-relays/runtime/dancelight/target/srtool ]; then
            ls -ln chains/orchestrator-relays/runtime/dancelight
            docker run --rm -v ${PWD}:/build alpine \
              sh -c "rm -rf /build/chains/orchestrator-relays/runtime/dancelight/target"
          else
            echo "dancelight srtool dir not found, skipping chown"
          fi