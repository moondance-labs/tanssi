name: Install frame-omni-bencher
description: |
  Install frame-omni-bencher

runs:
  using: "composite"
  steps:
    - name: Run sccache-cache
      uses: mozilla-actions/sccache-action@v0.0.9

    - name: Setup Variables
      shell: bash
      run: |
        echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
        echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
        echo "SCCACHE_CACHE_SIZE=100GB" >> $GITHUB_ENV  
        # Set RUSTFLAGS if not already set
        if [ -z "$RUSTFLAGS" ]; then
          echo "RUSTFLAGS=-C opt-level=3 -D warnings -C linker=clang -C link-arg=-fuse-ld=$(pwd)/mold/bin/mold" >> $GITHUB_ENV
        fi

    - name: Install frame-omni-bencher
      shell: bash
      run: |
        BRANCH=$(grep -m1 'moondance-labs/polkadot-sdk' Cargo.lock \
          | sed -E 's/.*branch=([^#"]+).*/\1/')
        cargo install frame-omni-bencher --locked --git https://github.com/moondance-labs/polkadot-sdk --branch $BRANCH --force
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH